# ローカル開発環境 詳細手順 (OPERATIONS-local.md)

このドキュメントは、`obi-scalp-bot` のローカル開発環境を **Windows 11 + WSL2 (Windows Subsystem for Linux 2)** 環境に構築し、効率的な開発サイクル（特にバックテスト）を回すための詳細な手順、ヒント、FAQを提供します。`README.md` のクイックスタートを補完するものです。

## 1. 環境構築

`README.md` に記載のセットアップ手順に加え、ローカル開発を円滑に進めるための推奨環境です。

-   **WSL2 と Docker Desktop**: パフォーマンス向上のため、プロジェクトファイルは必ずWSL2ファイルシステム内 (`/home/username/projects` など) に配置してください。Docker Desktop の WSL2 Integration は必須です。
-   **Go**: ローカルで `go test` を実行したり、IDEの補完機能を最大限活用するために、WSL2内にGo言語環境をセットアップしてください。
-   **VS Code**: [Remote - WSL](https://marketplace.visualstudio.com/items?itemName=ms-vscode-remote.remote-wsl) 拡張機能の利用を強く推奨します。`code .` コマンドでWSL2内のプロジェクトを直接開くことで、快適な開発体験が得られます。
-   **データベースクライアント**: DBeaver, DataGrip, pgAdmin など、PostgreSQLに接続できるGUIクライアントを用意すると、DB内のデータ（取引履歴、指標など）の確認が容易になります。`make monitor` 実行後、`localhost:5432` で接続できます。
-   **Adminer (Web UI)**: 本プロジェクトには、Webブラウザベースの軽量データベース管理ツール「Adminer」が含まれています。`make monitor` 実行後、 http://localhost:8888 にアクセスすることで、DBのテーブル構造やレコードを簡単に確認できます。

## 2. ローカルでの開発・テストサイクル

ローカルでの開発は、主に **「CSVシミュレーションによる高速なロジック検証」** と **「DBリプレイによる忠実な動作確認」** の2つのフェーズを繰り返すことになります。

### フェーズ1: 高速なロジック検証 (CSVシミュレーション)

戦略ロジックやパラメータの大部分は、軽量なCSVファイルを使った高速なシミュレーションで検証できます。これにより、DBを都度リセットする必要がなく、試行錯誤のサイクルを大幅に短縮できます。

**典型的なワークフロー:**

1.  **テストデータの準備 (初回のみでOK)**
    本番DBに接続し、テストしたい期間のデータをCSVとしてエクスポートします。例えば、ボラティリティが高かった1時間分をエクスポートします。
    ```bash
    # データベースサービスを起動
    make monitor

    # 2024年1月1日の0時0分から1時0分までのデータをエクスポート
    make export-sim-data START_TIME='2024-01-01 00:00:00' END_TIME='2024-01-01 01:00:00'
    ```
    `simulation` ディレクトリに `order_book_updates_...csv` ファイルが作成されます。

2.  **コードとパラメータの修正**
    `internal/` 以下のGoコードを修正したり、`config/config.yaml` の戦略パラメータ（`long`, `short`セクションの閾値やTP/SLなど）を調整します。

3.  **シミュレーションの実行**
    `make simulate` コマンドでバックテストを実行します。
    ```bash
    make simulate CSV_PATH=./simulation/order_book_updates_...csv
    ```

4.  **結果の確認と反復**
    コンソールに出力されるサマリー（総損益、勝率など）を確認します。期待通りの結果でなければ、手順2に戻ってコードやパラメータを再修正し、再度シミュレーションを実行します。このサイクルを素早く回すことが、効率的な開発の鍵です。

### フェーズ2: 忠実な動作確認 (DBリプレイ)

CSVシミュレーションで良好な結果が得られたロジックやパラメータが、より本番に近い環境でも正しく動作するかを最終確認します。DBリプレイは、DBへの書き込み、複数指標の相互作用、時間経過を含むすべてのコンポーネントを統合してテストします。

**典型的なワークフロー:**

1.  **設定の確認**
    `config/config.yaml` の `replay` セクションで、テストしたい期間が設定されていることを確認します。

2.  **DBリプレイの実行**
    ```bash
    make replay
    ```
    このコマンドは、指定された期間のDBデータを読み込み、ボットを動作させます。リプレイ中の取引やPnLは、すべてリプレイ用のセッションIDと共にDBに書き込まれます。

3.  **詳細な結果分析 (Grafana)**
    リプレイ完了後、Grafanaで結果を詳細に分析します。
    ```bash
    # DBとGrafanaを起動
    make monitor
    ```
    ブラウザで `http://localhost:3000` にアクセスし、ダッシュボードを開きます。データソースを `TimescaleDB (Replay)` に切り替えることで、リプレイ結果（損益曲線、個々の取引タイミングなど）を視覚的に確認できます。

## 3. バックテスト手法の使い分け

| 観点         | CSVシミュレーション (`make simulate`)                                  | DBリプレイ (`make replay`)                                                              |
| :----------- | :--------------------------------------------------------------------- | :-------------------------------------------------------------------------------------- |
| **目的**     | **戦略ロジック・パラメータの高速チューニング**                               | **本番に近い環境での最終的な動作検証**                                                      |
| **速度**     | **非常に高速** (数秒〜数十秒)                                            | 比較的低速 (DBからのデータ読み込みと書き込みが発生)                                         |
| **再現性**   | 板情報スナップショットのみを再現                                         | **完全な再現性** (板情報、約定、遅延など全イベントを再現)                                     |
| **依存関係** | CSVファイルのみ                                                        | **Docker, TimescaleDB, Grafana**                                                        |
| **ユースケース** | ・新しい指標ロジックの単体テスト<br>・TP/SL値の最適化<br>・シグナル閾値の探索 | ・複数コンポーネントの結合テスト<br>・DB書き込みロジックの検証<br>・本番デプロイ前の最終確認 |

## 4. トラブルシューティング / FAQ

### Q1: `make simulate` 実行時に `CSV_PATH is not set` と表示される
**A1:** `make simulate` コマンドには、`CSV_PATH` 引数で入力となるCSVファイルを指定する必要があります。
   ```bash
   # 正しい例
   make simulate CSV_PATH=./simulation/order_book_updates_...csv
   ```
   `ls -l simulation/` を実行して、ファイルが存在することを確認してください。

### Q2: `make export-sim-data` が `permission denied` やDB接続エラーになる
**A2:**
- まず `make monitor` を実行して、データベースコンテナが起動していることを確認してください。
- `.env` ファイルの `DB_USER`, `DB_PASSWORD`, `DB_NAME` が `docker-compose.yml` の定義と一致しているか確認してください。
- `sudo` なしで `docker` コマンドを実行できるユーザーでない場合、パーミッションエラーが発生することがあります。

### Q3: WSL2 のパフォーマンスが悪い (特にディスクI/O)
**A3:** プロジェクトファイルは必ずWSL2ファイルシステム内 (`/home/username/...` など) に配置してください。Windowsファイルシステム (`/mnt/c/...`) 経由でのアクセスは非常に遅くなります。

### Q4: DBリプレイの結果がGrafanaに表示されない
**A4:**
- `make replay` が正常に完了したか、ログを確認してください。
- `make monitor` でGrafanaとDBが起動していることを確認してください。
- Grafanaダッシュボードの右上にある時間範囲セレクターが、リプレイを実行した期間を含んでいるか確認してください。
- ダッシュボード左上の `Datasource` ドロップダウンで `TimescaleDB (Replay)` が選択されているか確認してください。

### Q5: `make up` 実行時にパーミッションエラーが発生する
**A5:** Dockerソケット (`/var/run/docker.sock`) へのアクセス権がない可能性があります。現在のユーザーを `docker` グループに追加してください: `sudo usermod -aG docker $USER`。その後、WSLセッションを再起動（ターミナルを閉じて再度開く）する必要があります。

---
*このドキュメントは、一般的なWSL2開発環境を想定しています。個別の環境差異により追加の調整が必要になる場合があります。*
