# 本番運用手順 (OPERATIONS.md)

このドキュメントは、`obi-scalp-bot` を Google Cloud Run および Cloud SQL (PostgreSQL + TimescaleDB) を用いて本番環境で運用するための手順、監視方法、障害対応について記述します。

**注意: このドキュメントはプロジェクトの進行に合わせて継続的に更新されます。**

## 1. はじめに

- **対象読者**: 本システムの開発者、運用担当者
- **目的**: 安定した本番運用を実現するための標準手順の提供
- **アーキテクチャ概要**: (ここに本番環境のアーキテクチャ図や主要コンポーネントの説明を簡潔に記述 - 後日追記)
    - Google Cloud Run: Botアプリケーションの実行環境
    - Google Cloud SQL (PostgreSQL + TimescaleDB): 時系列データ (板情報、約定履歴、PnL等) の保存
    - Google Cloud Logging & Monitoring: ログ収集、メトリクス監視、アラート設定
    - (その他、Secret Manager, Artifact Registry など)

## 2. デプロイ手順

### 2.1. 前提条件

- Google Cloud Project がセットアップ済みであること
- `gcloud` CLI がインストール・認証済みであること
- 必要な IAM 権限が付与されていること (Cloud Run Admin, Cloud SQL Admin, etc.)
- Docker イメージが Google Artifact Registry にプッシュ済みであること (CI/CD パイプライン経由を推奨)

### 2.2. Cloud SQL (PostgreSQL + TimescaleDB) のセットアップ

*(初回のみ、または構成変更時)*

1.  **インスタンス作成**:
    - リージョン、マシンタイプ、ストレージサイズ等を指定。
    - PostgreSQL バージョン (TimescaleDB互換のもの) を選択。
    - ネットワーク設定 (VPC Private IP推奨)。
    - (詳細な `gcloud sql instances create` コマンド例 - 後日追記)
2.  **データベース作成**:
    - Bot 用のデータベース (`coincheck_data` 等) を作成。
    - (詳細な `gcloud sql databases create` コマンド例 - 後日追記)
3.  **ユーザー作成**:
    - Bot 用のデータベースユーザー (`bot` 等) を作成し、パスワードを設定 (Secret Manager推奨)。
    - (詳細な `gcloud sql users create` コマンド例 - 後日追記)
4.  **TimescaleDB 拡張機能の有効化**:
    - `CREATE EXTENSION IF NOT EXISTS timescaledb CASCADE;` を該当データベースで実行。
    - (接続方法と実行コマンド - 後日追記)
5.  **ハイパーテーブルの作成**:
    - Bot が使用するテーブル (例: `order_books`, `trades`, `pnl`) を作成し、ハイパーテーブルに変換。
    - (DDL文の例 - 後日追記)
6.  **Cloud SQL Proxy (ローカル接続用、任意)**:
    - ローカルからのDBメンテナンス等で必要な場合にセットアップ。

### 2.3. Cloud Run へのデプロイ

1.  **環境変数の設定**:
    - `COINCHECK_API_KEY`, `COINCHECK_API_SECRET`: Secret Manager から参照。
    - `DB_HOST`: Cloud SQL インスタンスの Private IP アドレス。
    - `DB_PORT`: `5432` (デフォルト)。
    - `DB_USER`, `DB_PASSWORD`: Secret Manager から参照。
    - `DB_NAME`: 作成したデータベース名。
    - `LOG_LEVEL`: `info` や `warn` など運用ポリシーに合わせて設定。
    - (その他必要な設定項目)
2.  **Cloud Run サービス作成/更新**:
    - `gcloud run deploy [SERVICE_NAME] --image [IMAGE_PATH] ...` コマンドを使用。
    - リージョン、CPU/メモリ割り当て、最小/最大インスタンス数、タイムアウト等を設定。
    - Cloud SQL への接続設定 (VPCコネクタ経由)。
    - (詳細な `gcloud run deploy` コマンド例 - 後日追記)
3.  **動作確認**:
    - Cloud Run のログを確認。
    - ヘルスチェックエンドポイント (例: `/healthz`) にアクセス (実装後)。
    - Coincheck API との通信、DBへの書き込み等を確認。

## 3. 監視

### 3.1. Google Cloud Logging

- **ログの確認**: Cloud Run サービスから出力される標準出力/標準エラーログは自動的に収集されます。
- **ログベースのメトリクス**: 特定のログパターン (エラー、警告など) からメトリクスを作成し、アラートに利用。
- **フィルタリング**: 重大度、特定の文字列などでログをフィルタリングして調査。

### 3.2. Google Cloud Monitoring

- **標準メトリクス**: Cloud Run のリクエスト数、レイテンシ、コンテナCPU/メモリ使用率など。
- **カスタムメトリクス**: (Botアプリケーションから Prometheus 形式などで公開し、収集 - 後日検討)
- **ダッシュボード**: 主要なメトリクスをまとめたカスタムダッシュボードを作成。
- **アラート設定**:
    - エラーレートの上昇
    - 5xx レスポンスの増加 (ヘルスチェック等)
    - CPU/メモリ使用率の閾値超過
    - Bot の異常終了 (ログベースメトリクスから)
    - WebSocket 接続の長時間切断 (カスタムメトリクス or ログ)
    - PnL の急激な悪化 (DBの値から or Botのログ)
    - (具体的なアラートポリシー設定例 - 後日追記)

### 3.3. TimescaleDB の監視

- Cloud SQL の標準的なデータベース監視メトリクス。
- ハイパーテーブルのサイズ、チャンク数、圧縮状況など (クエリで確認)。

## 4. 運用タスク

### 4.1. 定期作業

- **ライブラリ/Goバージョンの更新と再デプロイ**: セキュリティパッチ、バグ修正のため。
- **TimescaleDB のメンテナンス**: (必要に応じて VACUUM, ANALYZE など - Cloud SQL が自動で管理する部分も多い)
- **設定値のレビューと調整**: (市場状況の変化に応じたパラメータ調整など - Botのロジックとして実装する部分も含む)

### 4.2. 設定変更

- `config.yaml` の変更は、イメージ再ビルドとCloud Runの新リビジョンデプロイが必要。
- 環境変数 (APIキー等) の変更は、Cloud Runの新リビジョンデプロイ (Secret Managerの値更新だけでは反映されない場合があるため)。

## 5. 障害対応 (SOP - Standard Operating Procedures)

*(このセクションは具体的な障害シナリオとその対応手順を記述します - 後日拡充)*

### 5.1. Bot アプリケーションが頻繁に再起動する

1.  **ログ確認**: Cloud Logging でエラーメッセージやスタックトレースを確認。
2.  **原因特定**:
    - 設定ミス (APIキー、DB接続情報など)
    - コードのバグ (パニックなど)
    - 外部API (Coincheck, DB) の一時的な問題
    - リソース不足 (CPU/メモリ)
3.  **対応**:
    - 設定ミスの場合: 設定を修正し再デプロイ。
    - コードのバグ: ロールバック、修正して再デプロイ。
    - 外部APIの問題: APIのステータスを確認し、復旧を待つ。必要なら一時的にBotを停止。
    - リソース不足: Cloud Run のCPU/メモリ割り当てを増やす。

### 5.2. WebSocket 接続が切断されたままになる

1.  **ログ確認**: WebSocketクライアントの再接続試行ログ、エラーメッセージを確認。
2.  **Coincheck API ステータス確認**: Coincheck の障害情報を確認。
3.  **ネットワーク確認**: VPCコネクタ、ファイアウォールルール等を確認。
4.  **対応**:
    - Botの再起動。
    - Coincheck側の問題であれば復旧を待つ。

### 5.3. 指値注文が通らない、またはエラーになる

1.  **ログ確認**: 取引APIリクエスト/レスポンスのログを確認。エラーコード、メッセージを特定。
2.  **Coincheck API ドキュメント確認**: エラーコードの意味を調査。
3.  **口座状況確認**: 証拠金残高、既存ポジションなどをCoincheck管理画面で確認。
4.  **対応**:
    - APIキー権限不足、残高不足などであれば修正。
    - 一時的なAPIエラーであれば時間を置いて再試行 (Botのロジックで対応)。

### 5.4. PnL が急激に悪化している

1.  **ログ確認**: 取引履歴、シグナル発生状況、エラーログを確認。
2.  **市場状況確認**: BTC/JPY の急変動、Coincheckのメンテ情報などを確認。
3.  **リスク管理設定確認**: `config.yaml` の損切り設定、ロットサイズ設定などを確認。
4.  **対応**:
    - 緊急停止条件に該当すればBotは自動停止するはず。手動で停止が必要な場合は Cloud Run からインスタンス数を0にするか、特定の環境変数を更新してBotを安全停止させる仕組みを検討。
    - バグが疑われる場合は調査し修正。

## 6. セキュリティ

- **APIキー管理**: Secret Manager を使用。IAM権限を最小限に。
- **DB認証情報管理**: Secret Manager を使用。
- **VPC Service Controls**: (可能であれば検討)
- **定期的な脆弱性スキャン**: (コンテナイメージ、ライブラリ)

---
*このドキュメントは初期バージョンです。運用を通じて得られた知見を元に、継続的に改善していきます。*
