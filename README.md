# OBI Scalp Bot

**OBI Scalp Bot**は、複数の市場マイクロストラクチャ指標をリアルタイムで分析し、高頻度なスキャルピング取引を行うGo言語製の取引ボットです。

Coincheck APIと連携し、Order Book Imbalance (OBI) を中心としつつ、Order Flow Imbalance (OFI), Cumulative Volume Delta (CVD) などの補助指標を組み合わせて、より精度の高い取引シグナルを生成します。

## 主な特徴

-   **マルチ指標によるシグナル生成**:
    -   **OBI (Order Book Imbalance)**: 板情報の買い圧力と売り圧力の不均衡を捉えます。
    -   **OFI (Order Flow Imbalance)**: OBIに約定情報を加え、より市場の実態に近いフローを分析します。
    -   **CVD (Cumulative Volume Delta)**: 一定期間の買い約定と売り約定の差分を累積し、短期的なトレンドの勢いを測ります。
    -   **MicroPrice**: 最良気配値だけでは捉えきれない、板の厚みを考慮した実質的な価格を計算します。
-   **リアルタイム処理**: CoincheckのWebSocket APIを利用して、リアルタイムに板情報・取引情報を取得し、遅延の少ないシグナル判断を実現します。
-   **動的パラメータ調整**: 市場のボラティリティを算出し、状況に応じて取引パラメータ（利確・損切り幅など）を動的に調整する機能を持ちます。
-   **高度な注文執行**:
    -   **TWAP注文**: 大きな注文を時間で分割して発注し、市場へのインパクトを抑えます。
    -   **自動注文調整**: 発注した指値注文が市場価格から乖離した場合、自動でキャンセルして再発注するロジックを搭載しています。
-   **堅牢なデータ永続化**: TimescaleDB（PostgreSQLベースの時系列データベース）に、取引履歴、板情報、計算した各種指標を効率的に保存・圧縮します。
-   **豊富なバックテスト機能**:
    -   **DBリプレイ**: データベースに保存された過去の全イベント（板情報・約定）を忠実に再現する、高精度なバックテスト。
    -   **CSVシミュレーション**: DBからエクスポートした軽量なCSVファイルを使い、特定の戦略パラメータを高速に検証するためのシミュレーション。
-   **パフォーマンス可視化**: Grafanaと連携し、累積損益、勝率、取引履歴などを視覚的に分析できるダッシュボードを提供します。

## アルゴリズムと戦略パラメータ

本ボットは、複数の指標を組み合わせて取引シグナルを生成します。主要なロジックと関連パラメータは以下の通りです。

### 1. 主要指標

-   **OBI (Order Book Imbalance)**
    -   **目的**: 板情報における買い注文と売り注文の圧力の不均衡を測定します。OBIが高い値を示す場合、買い圧力が強い（価格上昇の可能性）と判断し、低い（負の）値の場合は売り圧力が強い（価格下落の可能性）と判断します。
    -   **関連パラメータ**: `long.obi_threshold`, `short.obi_threshold`
-   **OFI (Order Flow Imbalance)**
    -   **目的**: OBIが板の静的な状態を捉えるのに対し、OFIは実際に成立した約定情報を加味します。これにより、市場参加者の真の行動（成行注文など）を反映した、より動的な需給バランスを分析します。
-   **CVD (Cumulative Volume Delta)**
    -   **目的**: 一定期間の「買い約定量」から「売り約定量」を引いた差を累積します。CVDの上昇は買い意欲の継続を、下降は売り意欲の継続を示唆し、短期的なトレンドの勢いを判断するのに役立ちます。
-   **MicroPrice**
    -   **目的**: 最良気配値だけでなく、その周辺の板の厚み（流動性）も考慮に入れて、実質的な市場価格を算出します。これにより、スプレッドが広い状況や板が薄い状況でも、より安定した価格評価が可能になります。

### 2. シグナル生成ロジック

1.  **OBI閾値超過**: OBIの値が `trade_config.yaml` で設定された `obi_threshold` を超えた場合、エントリーシグナルの「候補」となります。
2.  **シグナル確定待機 (Hold Duration)**: シグナル候補が発生しても即座にエントリーはしません。`signal.hold_duration_ms` で設定された時間、OBIが閾値を超え続けた場合にのみ、シグナルが「確定」します。これは、瞬間的なノイズ（ダマシ）を避けるためのフィルターです。
3.  **OBI傾きフィルター (Slope Filter)**: （有効な場合）シグナル確定時に、OBIの短期的な変化率（傾き）を計算します。`signal.slope_filter.threshold` で設定された勢いがない場合、トレンドが弱いと判断しエントリーを見送ります。
4.  **動的OBI閾値 (Dynamic OBI)**: （有効な場合）市場のボラティリティを常に計算し、変動が激しい相場ではOBIの閾値を自動的に引き上げ（より強いシグナルを要求）、静かな相場では引き下げます。これにより、市場環境に適応した取引判断を目指します。

### 3. 執行戦略とリスク管理

-   **ポジションサイズ**: `lot_max_ratio` と `order_ratio` に基づいて決定されます。`adaptive_position_sizing` が有効な場合、直近の損益に応じて `order_ratio` が自動調整されます。
-   **利食い(TP)と損切り(SL)**: `long.tp`/`short.tp` と `long.sl`/`short.sl` で設定された固定幅で執行されます。
-   **TWAP注文**: `twap.enabled` がtrueの場合、大きな注文は `twap.max_order_size_btc` のサイズに分割され、`twap.interval_seconds` の間隔で発注されます。
-   **最大ドローダウン**: `risk.max_drawdown_percent` を超える損失が発生した場合、システムは自動的に新規注文を停止します。

## 技術スタック

-   **言語**: Go
-   **データベース**: TimescaleDB (PostgreSQL + TimescaleDB拡張)
-   **可視化**: Grafana
-   **コンテナ化**: Docker, Docker Compose

## セットアップ

### 前提条件

-   Docker および Docker Compose がインストールされていること
-   `make`コマンドが利用できること

### 1. リポジトリのクローン

```bash
git clone https://github.com/your-org/obi-scalp-bot.git
cd obi-scalp-bot
```

### 2. 環境変数の設定

`.env.sample` ファイルをコピーして `.env` ファイルを作成し、必要な情報を設定します。

```bash
cp .env.sample .env
```
`.env`ファイルの中身を編集してください。

```
# Coincheck API
COINCHECK_API_KEY="YOUR_API_KEY"
COINCHECK_API_SECRET="YOUR_API_SECRET"

# Database
DB_USER="your_db_user"
DB_PASSWORD="your_db_password"
DB_NAME="obi_scalp_bot_db"

# Grafana
GRAFANA_USER="admin"
GRAFANA_PASSWORD="admin"
```

### 3. 設定ファイルの確認

本プロジェクトの設定は、役割に応じて2つのファイルに分割されています。

-   `config/trade_config.yaml`: **取引戦略に関する設定**
    -   取引ペア、OBI閾値、利食い・損切り幅、ポジションサイズなど、ボットの売買ロジックに直接関わるパラメータを管理します。
    -   戦略を調整する際は、主にこのファイルを編集します。各項目の詳細はファイル内のコメントを参照してください。

-   `config/app_config.yaml`: **アプリケーション全体に関する設定**
    -   データベース接続情報、ログレベル、リプレイモードの設定など、システム全体の動作に関わるパラメータを管理します。
    -   通常、一度設定した後は頻繁に変更する必要はありません。

## 実行方法

### 通常起動（本番トレード）

以下のコマンドで、ボットと関連サービス（データベース、Grafana）を起動します。

```bash
make up
```

### 監視のみ

ボットを起動せず、データベースとGrafanaのみを起動します。過去の取引結果を分析する際などに使用します。

```bash
make monitor
```

### ログの確認

```bash
make logs
```

### PnLレポートの生成

コンソールに現在のパフォーマンスサマリーを表示します。

```bash
make report
```

### サービスの停止

```bash
make down
```

## バックテスト

本プロジェクトでは、目的の異なる2種類のバックテスト手法を提供します。

### 1. DBリプレイ（高精度バックテスト）

データベースに保存された過去の市場データ（板情報、取引履歴）を時系列に沿って忠実に再現し、本番とほぼ同じ環境で戦略のパフォーマンスを検証します。

**設定:**
バックテストの期間は `config/app_config.yaml` 内の `replay` セクションで設定します。

```yaml
replay:
  # バックテストの開始時刻 (UTC)
  # 形式: "YYYY-MM-DDTHH:MM:SSZ"
  start_time: "2024-01-01T00:00:00Z"

  # バックテストの終了時刻 (UTC)
  # 形式: "YYYY-MM-DDTHH:MM:SSZ"
  end_time: "2024-01-02T00:00:00Z"
```

**実行:**
```bash
make replay
```
リプレイ完了後、結果はデータベースに保存され、Grafanaダッシュボードで詳細な分析が可能です。

### 2. CSVシミュレーション（高速パラメータチューニング）

特定の期間の板情報スナップショットをCSVファイルとして軽量化し、データベースを介さずに高速で戦略パラメータの検証を行うためのモードです。

**ステップ1: CSVデータの準備**

まず、データベースに保存されている過去の板情報をCSVファイルにエクスポートします。`START_TIME`と`END_TIME`には、エクスポートしたいデータの期間を `YYYY-MM-DD HH:MM:SS` 形式で指定します。

```bash
make export-sim-data START_TIME='2024-01-01 00:00:00' END_TIME='2024-01-01 01:00:00'
```
このコマンドは、`./simulation/` ディレクトリにCSVファイルを生成します。

**ステップ2: パラメータの設定**

シミュレーションには `config/trade_config.yaml` の戦略パラメータが使用されます。このファイルを編集して、検証したい値を設定してください。

**ステップ3: シミュレーションの実行**

以下のコマンドを実行します。`CSV_PATH`には準備したCSVファイルのパスを指定します。

```bash
make simulate CSV_PATH=./simulation/your_exported_file.csv
```

**ステップ4: 結果の確認**

シミュレーションが完了すると、コンソールにパフォーマンスサマリーが出力されます。

```
==== シミュレーション結果 ====
総損益　     : +1234.56 JPY
取引回数     : 20回
勝率         : 60.00% (6勝/4敗)
平均利益/損失: +150.00 JPY / -75.00 JPY
最大ドローダウン: N/A
==========================
```

## Grafanaダッシュボード

`make up` または `make monitor` を実行後、ブラウザで http://localhost:3000 にアクセスします。
`.env` で設定したユーザー名とパスワードでログインしてください（デフォルト: admin/admin）。

## Adminerによるデータベース閲覧

`make up` または `make monitor` を実行後、ブラウザで http://localhost:8888 にアクセスすると、Adminerの管理画面が開きます。
以下の情報でデータベースに接続できます。

-   **System**: `PostgreSQL`
-   **Server**: `timescaledb`
-   **Username**: (`.env`で設定した`DB_USER`)
-   **Password**: (`.env`で設定した`DB_PASSWORD`)
-   **Database**: (`.env`で設定した`DB_NAME`)

## 開発

### テストの実行

```bash
make test
```

### ローカルビルド

```bash
make build
```

**注意**: `docker` コマンドの実行に `sudo` が必要な環境では、`Makefile` が `sudo -E` を使用して環境変数を引き継ぐように設定されています。`sudo` なしで `docker` を実行できるユーザーは、`Makefile` 内の `sudo -E` を削除してください。
