# ----------------------------------------------------------
#  Postgres 16 (Alpine) + TimescaleDB extension via apk
#  * ã‚¤ãƒ¡ãƒ¼ã‚¸ â‰ˆ120â€¯MB
#  * order_book_updates ã‚’ã‚¹ãƒˆãƒªãƒ¼ãƒ ã§ãƒ­ãƒ¼ãƒ‰
# ----------------------------------------------------------
FROM postgres:16-alpine

# 1. TimescaleDB ã¨ unzip ã‚’è¿½åŠ 
USER root
RUN echo "https://dl-cdn.alpinelinux.org/alpine/edge/testing" >> /etc/apk/repositories \
 && apk update \
 && apk add --no-cache timescaledb unzip

# 2. ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆã§ ZIP â†’ æ—¥ä»˜ç½®æ› â†’ COPY (ã‚¹ãƒˆãƒªãƒ¼ãƒ )
RUN cat > /docker-entrypoint-initdb.d/20_seed_stream.sh <<'EOSH'
#!/bin/sh -e
echo "ðŸŒ±  Streaming order_book_updates â€¦"
DATA_ZIP="/seed/order_book_updates_jules.zip"
if [ ! -f "$DATA_ZIP" ]; then
  echo "âš ï¸  $DATA_ZIP not found; skipping seed." >&2
  exit 0
fi
TODAY=$(date -u "+%Y-%m-%d")
psql -v ON_ERROR_STOP=1 --username="$POSTGRES_USER" --dbname="$POSTGRES_DB" <<'EOSQL'
CREATE EXTENSION IF NOT EXISTS timescaledb;
CREATE UNLOGGED TABLE IF NOT EXISTS order_book_updates (
  time TIMESTAMPTZ NOT NULL,
  pair TEXT NOT NULL,
  side TEXT NOT NULL CHECK (side IN ('bid','ask')),
  price DECIMAL NOT NULL,
  size  DECIMAL NOT NULL,
  is_snapshot BOOLEAN NOT NULL DEFAULT FALSE
);
EOSQL
unzip -p "$DATA_ZIP" \
| awk -F, -v d="$TODAY" 'NR==1{print;next}{sub(/^[0-9]{4}-[0-9]{2}-[0-9]{2}/, d, $1); OFS=","; print}' \
| psql --username="$POSTGRES_USER" --dbname="$POSTGRES_DB" \
       -c "\COPY order_book_updates (time,pair,side,price,size,is_snapshot) FROM STDIN CSV HEADER"
echo "âœ…  Seed completed"
EOSH
RUN chmod +x /docker-entrypoint-initdb.d/20_seed_stream.sh

# 3. ä½™åˆ†ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤ã§è‹¥å¹²åœ§ç¸®
RUN rm -rf /usr/share/doc /usr/share/man /var/cache/apk/*
USER postgres
EXPOSE 5432
CMD ["postgres", "-c", "shared_preload_libraries=timescaledb"]
