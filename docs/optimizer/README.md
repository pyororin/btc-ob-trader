# `optimizer` サービス 詳細設計書

## 1. サービスの概要

`optimizer`は、取引戦略のパラメータを自動的に最適化するためのコンポーネント群です。
本番稼働中のパフォーマンス劣化を監視し、軽微なパラメータ調整を自動で行うプロセスです。
`drift-monitor`サービスがパフォーマンス低下を検知すると、`optimizer`サービスをトリガーし、直近のデータで小規模な最適化を実行して`trade_config.yaml`を更新します。

## 2. アーキテクチャと処理フロー

### Drift-Monitorによる継続的最適化の処理フロー

これは本番稼働中の自動調整プロセスです。パフォーマンスの劣化を検知すると、単純なIS/OOS最適化ではなく、より堅牢な**ウォークフォワード分析 (WFA)** を実行してパラメータの有効性を検証します。

1.  **ドリフト検知**: `drift-monitor`が`pnl_summary`テーブルを監視し、パフォーマンス低下（シャープレシオの悪化など）を検知します。
2.  **ジョブ発行**: `optimization_job.json`ファイルを`/data/params`に作成します。
3.  **ウォークフォワード分析の実行**: `optimizer`サービスがジョブファイルを検知し、静的な単一分割ではなく、**ウォークフォワード分析 (`walk_forward.py`)** を開始します。
    -   直近のデータ（例: 過去30日間）を、複数の連続した学習(Train)フェーズと検証(Validate)フェーズに分割します（例: 5スプリット）。
    -   各スプリットで「学習→検証」を繰り返し、パラメータセットの堅牢性を評価します。
4.  **設定更新**: WFA全体の成功率が設定された閾値（例: `min_success_ratio: 0.6`）を上回った場合にのみ、最新の成功したスプリットから得られた最良パラメータを`/data/params/trade_config.yaml`に保存します。これにより、一時的な市場状況に過剰適合した不安定なパラメータが本番環境に適用されるリスクを大幅に低減します。稼働中の`bot`サービスは、更新されたファイルを自動でリロードします。

## 3. モジュール構成

-   `optimizer/main.py`: ファイル監視ループも含む。
-   `optimizer/study.py`: 1サイクル分のOptuna最適化（IS最適化とOOS検証）を実行し、結果を返す。
-   `optimizer/data.py`: 指定された時間枠のデータをエクスポートし、IS/OOSに分割する。
-   `optimizer/config.py`: `optimizer_config.yaml`から設定を読み込む。
-   `optimizer/objective.py`: Optunaの目的関数を定義する。`_suggest_parameters`メソッドは、`optimizer_config.yaml`内の`parameter_space`セクションに基づいてパラメータの探索範囲を動的に決定します。
-   `simulation.py`: Goのバックテストエンジンをサブプロセスとして呼び出す。

## 4. 設定ファイル (`config/optimizer_config.yaml`)

オプティマイザの挙動は、`config/optimizer_config.yaml`ファイルで詳細に設定できます。

-   `n_trials`: 1回の最適化サイクルで試行する回数。
-   `parameter_space`: Optunaが探索するパラメータの範囲を定義します。各パラメータについて、型（`int`, `float`, `categorical`）、範囲（`low`, `high`）、対数スケール（`log`）などを指定できます。このセクションを変更することで、ソースコードに触れることなく探索空間を調整できます。
-   `wfo_runner`: WFO全体の期間や、IS/OOSのウィンドウサイズなどを設定します。

### 枝刈り（Pruning）設定

最適化の効率を上げるため、見込みのない試行を早期に打ち切る「枝刈り」が行われます。以下のパラメータでその挙動を調整できます。

-   `min_trades_for_pruning`: 試行の取引回数がこの値を下回った場合に枝刈りします。非常に短い期間（例: 数時間）で最適化を行う場合、この値を小さくしないと有効な結果が得られないことがあります。
-   `dd_penalty_threshold`: 相対ドローダウン（最終資産に対する最大ドローダウンの割合）がこの閾値を超えた場合に枝刈りします。`1.0`に近いほど許容度が高くなります。

## 5. データベース

### `wfo_results` テーブル

WFOの各サイクルの結果を格納するために、新たに`wfo_results`テーブルが追加されました。

-   **役割**: 各サイクル（特定のIS/OOS期間）のパフォーマンス指標と、そのサイクルで見つかった最適なパラメータを記録します。
-   **主なカラム**:
    -   `cycle_id`: "cycle-01", "cycle-02"などの一意なID。
    -   `status`: サイクルの成功・失敗ステータス。
    -   `is_start_time`, `is_end_time`, `oos_end_time`: サイクルの期間。
    -   `is_*`, `oos_*`: ISとOOSそれぞれのパフォーマンス指標（Sharpe Ratio, Profit Factor, tradesなど）。
    -   `best_params`: OOS検証に合格したパラメータのJSON。
-   **目的**: このテーブルを分析することで、どのパラメータが様々な市場状況で安定して機能するか、また戦略がどのような市場で得意/不得意かを知ることができます。

## 5. 実行方法

### Walk-Forward Optimizationの実行

大規模なWFO分析を実行するには、以下のコマンドを使用します。

```bash
make run-wfo
```

-   このコマンドは`wfo-runner`サービスを起動します。
-   処理には非常に長い時間がかかることがあります。
-   実行中は、各サイクルのログがコンソールに出力されます。
-   完了後、全結果は`wfo_results`テーブルに格納されます。

### 継続的最適化の実行

`drift-monitor`と`optimizer`サービスは、`make up`でbotと共に自動的に起動します。手動で単発の最適化をトリガーする場合は、従来通り`make optimize`を使用できます。

## 5. 設計思想と考慮点

-   **堅牢性の徹底検証**: 単一のIS/OOS分割ではなく、多数のサイクルを連続して実行することで、パラメータが過剰適合していないかを徹底的に検証します。
-   **結果の永続化**: 全サイクルの結果をデータベースに保存することで、将来的な分析やレポーティングが容易になります。これにより、戦略の経時的なパフォーマンス変化や弱点を特定できます。
