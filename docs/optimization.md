# パラメータ最適化 (`optimizer.py`)

このドキュメントでは、`optimizer.py`スクリプトによる取引パラメータの最適化プロセスについて説明します。

## 概要

`optimizer.py`は、過去の市場データを用いて取引ボットのパフォーマンスを最大化するパラメータの組み合わせを見つけ出すためのスクリプトです。このプロセスは、主に以下の2つのフェーズで構成されます。

1.  **In-Sample (IS) 最適化**:
    *   指定された期間のデータ（ISデータ）を使用して、`Optuna`フレームワークによる最適化を実行します。
    *   目的関数（現在はSQN: System Quality Number）を最大化するようなパラメータの組み合わせを探索します。

2.  **Out-of-Sample (OOS) 検証**:
    *   IS最適化で得られた優秀なパラメータセットが、未知のデータ（OOSデータ）に対しても有効であるか（過剰最適化されていないか）を検証します。
    *   この検証を通過したパラメータセットのみが、実際の取引に使用される設定ファイル (`trade_config.yaml`) に反映されます。

## IS順位とOOS再検証（リトライ機構）

ISフェーズで成績が良かったパラメータが、必ずしもOOSフェーズでも良い結果を出すとは限りません。偶然ISデータにだけ適合してしまった（過剰最適化された）可能性があります。

このリスクを軽減し、より堅牢なパラメータを発見するため、本システムはISの成績上位のパラメータを順次OOSで再検証するリトライ機構を備えています。

### アルゴリズム

1.  IS最適化が完了すると、成績（SQN）が良かった順にパラメータセットのランキングが作成されます。
2.  ランキング1位のパラメータセットでOOS検証を実行します。
3.  OOS検証が事前に定義された合格基準（Profit Factor, Sharpe Ratioなど）を満たした場合、そのパラメータセットを採用し、プロセスは成功として終了します。
4.  不合格だった場合、ランキング2位のパラメータセットでOOS検証を試みます（リトライ）。
5.  このリトライは、以下のいずれかの条件を満たすまで、ランキング下位のパラメータセットを対象に繰り返されます。
    *   OOS検証に合格するパラメータセットが見つかる。
    *   事前に設定された最大リトライ回数に達する。
    *   成績の著しく悪いパラメータが連続し、早期停止条件に合致する。

### 設定項目

リトライ機構の挙動は `optimizer.py` 内の定数によって制御されます。

*   `MAX_RETRY`: OOS検証を試行する最大回数。ISランキングの上位何位までを検証対象とするかを定義します。
    *   デフォルト: `5`
*   `OOS_MIN_PROFIT_FACTOR`: OOS検証の合格基準となるProfit Factorの最小値。
    *   デフォルト: `1.0`
*   `OOS_MIN_SHARPE_RATIO`: OOS検証の合格基準となるSharpe Ratioの最小値。
    *   デフォルト: `0.5`
*   `EARLY_STOP_COUNT`: 早期停止の条件となる、連続不合格回数。
    *   デフォルト: `2`
*   `EARLY_STOP_THRESHOLD_RATIO`: 早期停止の判断に用いるSharpe Ratioの閾値係数。OOSのSharpe Ratioが `OOS_MIN_SHARPE_RATIO * EARLY_STOP_THRESHOLD_RATIO` を下回った場合に不合格カウントが1つ加算されます。
    *   デフォルト: `0.7`

### 結果の確認

最適化の実行結果は、`optimization_history`データベーステーブルに保存されます。Grafanaのダッシュボードを通じて、各試行の結果を視覚的に確認できます。

*   **is_rank**: 最終的に採用された、または最後に試行されたパラメータのIS時点でのランキング。
*   **retries_attempted**: OOS検証を試行した回数。
*   **validation_passed**: OOS検証に最終的に合格したかどうか (`true`/`false`)。

これらの指標をモニタリングすることで、最適化プロセスが健全に機能しているかを判断できます。例えば、`retries_attempted`が頻繁に`MAX_RETRY`に達し、`validation_passed`が`false`となるケースが多い場合、市場環境の変化やモデルの劣化が考えられ、再最適化のトリガーや取引戦略自体の見直しが必要になる可能性があります。
