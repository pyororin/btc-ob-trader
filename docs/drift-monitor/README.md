# `drift-monitor` サービス 詳細設計書

## 1. サービスの概要

`drift-monitor`サービスは、現在稼働している取引戦略のパフォーマンスを継続的に監視し、その性能が市場の実態から乖離（ドリフト）していないかを評価する重要な役割を担います。

パフォーマンスの悪化（ドリフト）を検知すると、`optimizer`サービスに対して再最適化を指示する「ジョブファイル」を作成します。これにより、システム全体が市場の変化に自律的に適応していく、自己修正ループの中核として機能します。

## 2. Docker Compose上の役割と設定

`docker-compose.yml`における`drift-monitor`サービスの定義は以下の通りです。

```yaml
services:
  drift-monitor:
    build:
      context: .
      dockerfile: optimizer/Dockerfile
    container_name: obi-scalp-drift-monitor
    command: python optimizer/drift_monitor.py
    # ... (volumes, env_file, etc.)
    depends_on:
      timescaledb:
        condition: service_healthy
```

### 設定解説

-   **`build`**: `optimizer`サービスと共通の`optimizer/Dockerfile`を使用してビルドされます。
-   **`command`**: コンテナ起動時に`optimizer/drift_monitor.py`スクリプトを実行します。
-   **`depends_on`**: `timescaledb`サービスが利用可能になってから本サービスを開始するように設定されています。
-   **`restart`ポリシー**: `docker-compose.yml`には`restart`ポリシーが定義されていません。これは、スクリプトが自身のループで永続的に動作するため、Docker側での自動再起動は不要と判断されている可能性があります。

## 3. 処理フローとロジック

`drift_monitor.py`は、設定された時間間隔（`CHECK_INTERVAL_SECONDS`）ごとに、以下のチェック処理を無限ループで実行します。

### 3.1. パフォーマンスデータの収集

1.  **データベース接続**: `timescaledb`に接続します。
2.  **パフォーマンスの集計**: `pnl_reports`テーブルをクエリし、指定した期間のパフォーマンス指標を集計します。監視する期間はスクリプト上部の`METRICS_WINDOWS_HOURS`定数（デフォルトは `[4, 1]`）で設定されており、それぞれ以下の集計が行われます。
    -   **直近1時間の集計値**: 期間内の全レポートについて、`sharpe_ratio`と`profit_factor`の平均値、`max_drawdown`の最大値を取得します。
    -   **直近4時間の集計値**: 1時間の場合と同様に、期間内の集計値を取得します。
3.  **長期ベースラインの取得**: 同じく`pnl_reports`テーブルから、スクリプト上部の`BASELINE_DAYS`定数（デフォルトは7日）で指定された過去日数のシャープレシオの移動平均（`mu`）と標準偏差（`sigma`）を計算します。これは、現在のパフォーマンスが「平常時と比べてどうか」を判断するための基準（ベースライン）となります。

### 3.2. ドリフトの検知ロジック

収集したデータを用いて、複数の条件でパフォーマンスの悪化を評価します。`METRICS_WINDOWS_HOURS`で指定された期間のうち、短い方を「短期」、長い方を「長期」として扱います。

-   **Zスコアの計算**: 集計された平均シャープレシオが、長期的なベースラインからどれだけ統計的に離れているかを測るために、Zスコアを計算します。
    -   `Zスコア = (集計期間の平均シャープレシオ - ベースライン期間の平均シャープレシオ) / ベースライン期間の標準偏差`

-   **ドリフト判定**:
    1.  **軽微なドリフト (Minor Drift)**:
        -   **条件**: 短期（デフォルト1時間）のZスコアが、設定された閾値（例: -0.5）を下回る。
        -   **意味**: 短期的にパフォーマンスが少し悪化している兆候。
    2.  **深刻なドリフト (Major Drift / Emergency)**:
        -   **条件**: 短期と長期（デフォルト1時間と4時間）の両方のZスコアが、非常に厳しい閾値（例: -1.0）を下回る。
        -   **意味**: パフォーマンスが急激に悪化しており、緊急の対応が必要。
    3.  **通常のドリフト (Normal Drift)**:
        -   **条件**: 長期（デフォルト4時間）のプロフィットファクター（総利益 ÷ 総損失）が、閾値（例: 0.9）を下回る。
        -   **意味**: 収益性が悪化し、取引の質が低下している。**プロフィットファクターが0になった場合（取引がない、またはエラーで算出不能）も、パフォーマンスが悪化したとみなし、この条件に合致する。**

### 3.3. 最適化のトリガー

-   上記のいずれかのドリフトが検知されると、`trigger_optimization`関数が呼び出されます。
-   この関数は、`/data/params/optimization_job.json`というジョブファイルを作成します。
-   ジョブファイルには、検知されたドリフトの深刻度(`severity`)に応じて、`optimizer`が使用するデータの期間（`window_is`, `window_oos`）が書き込まれます。
    -   **深刻度が高いほど、より直近の短いデータを使って迅速に最適化を行うように設定されます。**
-   複数のドリフトが同時に検知された場合は、最も深刻度の高いものが優先されます（`major` > `normal` > `minor`）。

## 4. 設計思想と考慮点

-   **統計的プロセス管理 (SPC)**: Zスコアを用いて現在のパフォーマンスが過去の統計的な範囲から逸脱していないかを監視する手法は、統計的プロセス管理の考え方に基づいています。これにより、単なる損益の浮き沈みではなく、統計的に有意なパフォーマンスの変化を捉えることができます。
-   **段階的な対応**: ドリフトの深刻度を「軽微」「通常」「深刻」の3段階に分けることで、状況に応じた適切な対応を可能にしています。パフォーマンスの少しの揺らぎで毎回大規模な最適化が走るのを防ぎつつ、緊急時には迅速に対応する、バランスの取れた設計です。
-   **疎結合なアーキテクチャ**: `drift-monitor`は再最適化を直接実行するのではなく、ジョブファイルを作成するだけです。`optimizer`サービスはこのファイルを監視しており、ファイルが作成されたら自身のタイミングで最適化を開始します。このように役割を分離することで、サービス間の依存関係を低く保ち（疎結合）、システム全体の柔軟性と拡張性を高めています。

## 5. 想定ユースケースとトリガー

-   **ユースケース**: 24時間365日稼働する取引システムにおいて、市場の変化によって既存の取引ロジックが陳腐化・劣化するのを自動的に検知し、自己修正プロセスを起動させる。
-   **トリガー**: サービス起動後、`CHECK_INTERVAL_SECONDS`で設定された時間間隔（デフォルトは300秒=5分）で自動的に実行されます。
